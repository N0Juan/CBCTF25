# Gandalf CTF Challenge Writeup

## Challenge Overview

- **Name:** Gandalf Crackme
- **Category:** Reverse Engineering  
- **Difficulty:** Medium
- **Theme:** Lord of the Rings

## Challenge Description

We're given a binary called `gandalf_crackme` that asks for a password to enter the Mines of Moria. Our goal is to reverse engineer the binary to find the correct password and retrieve the flag.

## Initial Reconnaissance

### Running the Binary

```bash
$ ./gandalf_crackme 
=== THE MINES OF MORIA ===
"Speak, friend, and enter"

You stand before the Doors of Durin...
The Watcher in the Water stirs in the dark lake behind you.
You must speak the password to enter the ancient dwarven realm.

Enter the password of Moria: test
YOU SHALL NOT PASS!
```

The binary asks for a password and rejects incorrect attempts with Gandalf's famous quote.

### Static Analysis

First, let's check what type of file we're dealing with:

```bash
$ file gandalf_crackme
gandalf_crackme: Mach-O 64-bit executable x86_64
```

## Reverse Engineering Process

### Step 1: Extract Key Memory Values

Using hexdump, we can extract important data from the binary:

```bash
$ hexdump -C gandalf_crackme | grep "3b90" -A 2
00003b90  1f 07 1d 06 1a 1b 14 0f  0e 0e 1d 04 1b 06 1d 02  |................|
00003ba0  04 04 18 04 14 1c 04 0f  09 00 09 09 6d 65 6c 6c  |............mell|
00003bb0  6f 6e 00 66 6c 61 67 2e  74 78 74 00 72 00 f0 9f  |on.flag.txt.r...|
```

From this output, we can identify:

- **Expected encrypted password** (at 0x3b90): 28 bytes starting with `1f 07 1d 06...`
- **XOR key** (at 0x3bac): `6d 65 6c 6c 6f 6e` which is ASCII for "mellon"

**Fun Fact:** "Mellon" is Elvish for "friend" - the password to enter Moria in LOTR!

### Step 2: Understanding the Encryption

By analyzing the binary (through decompilation or debugging), we find that the password check works as follows:

1. Takes user input
2. Applies ROT9 cipher (shifts each letter by 9 positions)
3. XORs the result with "mellon" (repeating key)
4. Compares with the expected bytes

### Step 3: Reversing the Encryption

To find the password, we need to reverse these operations:

1. Take the expected bytes
2. XOR with "mellon" to decrypt
3. Apply reverse ROT9 (which is ROT17, since 26-9=17)

## Solution Script

```python
#!/usr/bin/env python3

# Extracted from the binary at offset 0x3b90
expected = bytes.fromhex("1f071d061a1b140f0e0e1d041b061d0204041804141c040f09000909")
# XOR key "mellon" found at offset 0x3bac
xor_key = bytes.fromhex("6d656c6c6f6e")  # ASCII: "mellon"

print("[*] Starting decryption process...")
print(f"[*] XOR key: '{xor_key.decode()}' (Elvish for 'friend')")

# Step 1: XOR decrypt
decrypted = bytearray()
for i in range(len(expected)):
    decrypted.append(expected[i] ^ xor_key[i % 6])

print(f"[*] After XOR: {decrypted.decode('ascii')}")

# Step 2: Reverse ROT9 (apply ROT17)
def reverse_rot9(text):
    result = []
    for char in text:
        if 'a' <= char <= 'z':
            # Rotate backward by 9 = rotate forward by 17
            result.append(chr((ord(char) - ord('a') + 17) % 26 + ord('a')))
        elif 'A' <= char <= 'Z':
            result.append(chr((ord(char) - ord('A') + 17) % 26 + ord('A')))
        else:
            result.append(char)
    return ''.join(result)

password = reverse_rot9(decrypted.decode('ascii'))
print(f"[+] Password found: {password}")
```

### Running the Solution

```bash
$ python3 solve.py
[*] Starting decryption process...
[*] XOR key: 'mellon' (Elvish for 'friend')
[*] After XOR: rbqjuuyjbbrjvcqnkjuaxpkadeee
[+] Password found: ishallpassiamthebalrogbruvvv
```

## Getting the Flag

Now we can use the password to get the flag:

```bash
$ nc exploit.cyberbattle.info 9999
=== THE MINES OF MORIA ===
"Speak, friend, and enter"

Enter the password of Moria: ishallpassiamthebalrogbruvvv

=== THE BRIDGE OF KHAZAD-DÛM ===
You have spoken the ancient words!
The Balrog falls into the abyss...
Gandalf emerges as Gandalf the White!

FLAG: CBCTF{you_have_defeated_the_balrog_of_morgoth_gandalf_the_grey_has_fallen_but_returns_as_gandalf_the_white}

"I am Gandalf the White. And I come back to you now at the turn of the tide."
```

## Key Takeaways

### The Password: `ishallpassiamthebalrogbruvvv`

- A humorous twist on "You shall not pass!"
- Means "I shall pass, I am the Balrog bruvvv"

### Encryption Scheme:

- ROT9 cipher → XOR with "mellon"
- Simple but effective for a CTF challenge

### LOTR References:

- "Mellon" - the password to Moria in the books
- Gandalf's transformation from Grey to White
- The Balrog of Morgoth

## Flag

```
CBCTF{you_have_defeated_the_balrog_of_morgoth_gandalf_the_grey_has_fallen_but_returns_as_gandalf_the_white}
```

## Tools Used

- **hexdump** - for extracting binary data
- **python3** - for scripting the solution
- **nc (netcat)** - for connecting to the challenge server

---

*"Speak, friend, and enter" - but sometimes you need to pretend to be the Balrog!* 🧙‍♂️🔥
